import base64
import json

import nmslib
import numpy as np

from modules.utils import dfloat32

index = nmslib.init(method='hnsw', space='cosinesimil')

# with open('/media/thiennt/projects/remote_lvt/ekyc-lvt/application/test/embedding_log.jl', 'r') as f:
#     embeddings = []
#     ids = []
#     for i in range(100):
#         f.seek(0)
#         j = 0
#         for line in f:
#             record = json.loads(line.strip())
#             if record['face'] is not None:
#                 j += 1
#                 if j == 9195:
#                     print(record)
#                     break
#         exit(0)
  # embedding = base64.b64decode(record['face'])
  # embedding = np.frombuffer(embedding, dtype=dfloat32)
  # id = f"{record['_id']}_copy_{i}"
#
#   embeddings.append(embedding)
#   ids.append(id)
#         embeddings_np = np.array(embeddings)
#         index.addDataPointBatch(embeddings)
#         embeddings.clear()
#         ids.clear()


# index_time_params = {'M': 15, 'indexThreadQty': 4, 'efConstruction': 100}
# index.createIndex(index_time_params, print_progress=True)
#
# # query for the nearest neighbours of the first datapoint
# ids, distances = index.knnQuery(data[0], k=10)
#
# # get all nearest neighbours for all the datapoint
# # using a pool of 4 threads to compute
# neighbours = index.knnQueryBatch(data, k=10, num_threads=4)
#
# index.saveIndex("face_index.bin", save_data=True)
index.loadIndex("face_index.bin", load_data=True)


query = [0.038559991866350174,-0.014932200312614441,0.0055810874328017235,0.0181540809571743,-0.04621011018753052,0.013459660112857819,-0.0073764268308877945,-0.029286805540323257,-0.013772026635706425,-0.03592129051685333,-0.033410973846912384,-0.040471937507390976,0.0033524443861097097,-0.003190529765561223,-0.01859486848115921,-0.04622107744216919,-0.05660519003868103,-0.022521743550896645,0.04432835057377815,0.007421861402690411,0.018243396654725075,0.036092933267354965,0.06604760140180588,0.06267596781253815,0.01834493689239025,-0.029189689084887505,0.05196987837553024,-0.045502226799726486,-0.0031346536707133055,-0.11467071622610092,-0.010961822234094143,0.03555626422166824,0.039713311940431595,0.0900956392288208,-0.015196808613836765,0.014867187477648258,0.0047492096200585365,-0.012513196095824242,-0.042377907782793045,-0.029217693954706192,-0.01352386362850666,-0.047258637845516205,-0.07429274916648865,-0.0025409474037587643,-0.029033971950411797,0.04055071994662285,-0.04705748334527016,-0.007251284550875425,-0.018007781356573105,-0.03953317552804947,-0.005622304975986481,0.018936870619654655,-0.039111968129873276,-0.040325719863176346,0.04632040485739708,0.0034629092551767826,0.0025365883484482765,-0.054224785417318344,-0.051166508346796036,-0.0375831201672554,-0.045901164412498474,0.06265770643949509,-0.0019013129640370607,0.021134650334715843,0.03672325238585472,0.003923108801245689,0.009358292445540428,-0.029035232961177826,-0.04288351163268089,0.008935295976698399,-0.06125464662909508,-0.04900864139199257,0.039285313338041306,-0.015439455397427082,-0.020820338279008865,-0.0015493682585656643,-0.03587912395596504,0.0018431269563734531,-0.027638882398605347,0.03176266327500343,-0.027029044926166534,-0.0325934924185276,0.06480308622121811,0.02366611547768116,0.03402729704976082,-0.010050667449831963,-0.04436669126152992,-0.019450809806585312,-0.025216318666934967,0.036448318511247635,-0.03217476233839989,-0.019921787083148956,0.02315089851617813,0.02368828095495701,0.11321185529232025,-0.008151881396770477,0.0013796164421364665,-0.06013241037726402,-0.0830111876130104,0.053938668221235275,-0.01655888557434082,-0.01757671870291233,-0.0009834395023062825,-0.007037429604679346,0.00958279985934496,0.028571421280503273,-0.014444530941545963,-0.09516149759292603,0.03138190880417824,-0.022319644689559937,-0.08107264339923859,0.047041527926921844,-0.03375746309757233,0.0383601076900959,0.023140976205468178,-0.02769680880010128,0.0395599827170372,0.09073321521282196,-0.03317202255129814,0.003278219373896718,-0.006486649625003338,-0.020705416798591614,0.09973785281181335,0.1281999796628952,-0.02371593751013279,-0.030508194118738174,-0.004019649233669043,-0.05022859200835228,-0.03201022744178772,0.03544251248240471,0.03354339301586151,-0.004808743949979544,0.04815543442964554,-0.002345771761611104,-0.01991531066596508,-0.11604594439268112,0.04141777381300926,-0.010669895447790623,-0.06786923110485077,0.01509800460189581,-0.004855947569012642,-0.011553958058357239,0.04453093558549881,0.01996765471994877,0.09602110832929611,0.06472765654325485,0.01960650458931923,-0.0054016574285924435,-0.01795203797519207,-0.012135213240981102,0.0903070718050003,0.052683547139167786,-0.044575996696949005,0.0063160560093820095,0.002288705436512828,0.10951503366231918,-0.043645184487104416,-0.014813135378062725,0.05284297838807106,-0.013801864348351955,-0.05664653703570366,-0.03702938184142113,-0.04732260853052139,0.04532816633582115,0.08372407406568527,-0.010896099731326103,-0.06682856380939484,0.007734676823019981,0.04314004257321358,0.08073665201663971,-0.06892409920692444,0.049241188913583755,-0.04001147300004959,0.017391657456755638,0.05121593922376633,0.002183494856581092,-0.048268239945173264,0.08148981630802155,-0.006413346156477928,-0.004963184706866741,0.057349301874637604,-0.03441909700632095,-0.05240456387400627,-0.02423713728785515,0.03246166184544563,-0.0006880397559143603,0.018881676718592644,-0.020726079121232033,-0.04822428524494171,0.02596946433186531,0.04341950640082359,0.011917440220713615,0.030962077900767326,-0.011784106492996216,-0.0495108962059021,0.0448620431125164,0.005862934980541468,-0.022184552624821663,-0.024341026321053505,-0.05543284863233566,-0.005728842690587044,-0.011477679945528507,0.06998366117477417,0.06697096675634384,0.02349196933209896,-0.005115768406540155,0.014336640946567059,-0.005908177699893713,-0.00643460126593709,-0.11138535290956497,0.039604175835847855,0.009095758199691772,-0.000853906967677176,-0.01679140515625477,0.025899304077029228,-0.06981697678565979,0.032873526215553284,-0.01992921344935894,-0.04074174910783768,0.06793705374002457,0.03436316177248955,0.011307420209050179,-0.036871179938316345,0.018657630309462547,0.10142974555492401,-0.005259851925075054,-0.054644837975502014,0.042147569358348846,-0.007939443923532963,-0.03604253754019737,-0.05223798006772995,-0.0423879437148571,0.019102754071354866,-0.013420308008790016,-0.032370924949645996,-0.026168927550315857,-0.033011872321367264,-0.012016680091619492,-0.05487837269902229,0.04757179319858551,0.12649716436862946,0.008375563658773899,0.0020223285537213087,0.03144999220967293,-0.08788498491048813,-0.003893770044669509,-0.06997945159673691,-0.0010618030792102218,0.007380402646958828,0.0015730960294604301,-0.009857798926532269,-0.015436835587024689,0.030375143513083458,-0.017786363139748573,-0.09315229207277298,0.021795134991407394,-0.03832671418786049,-0.01544533483684063,-0.0064267851412296295,0.03142985329031944,-0.11218810081481934,0.053330857306718826,0.011439957655966282,-0.022726042196154594,0.07511574029922485,0.0551411397755146,-0.021802164614200592,-0.07904322445392609,-0.1035086065530777,0.01703919842839241,-0.008966648019850254,0.05669805034995079,-0.03538180887699127,-0.03103458695113659,0.05945580452680588,0.008206910453736782,-0.02899624966084957,0.10362014919519424,-0.0129633704200387,0.06523489207029343,-0.0005156418774276972,-0.0231781043112278,-0.034939322620630264,0.08458825200796127,0.005152113735675812,-0.04101235792040825,0.03331239894032478,-0.022121872752904892,-0.04818267747759819,-0.024549102410674095,0.08901508897542953,0.002099738921970129,-0.007569929584860802,0.1184353232383728,0.033027712255716324,-0.03419019281864166,0.02083214931190014,-0.08122140914201736,0.027069050818681717,0.0003654816828202456,0.0908379778265953,-0.040483634918928146,-0.04658704623579979,0.05271923169493675,0.010952291078865528,-0.04377737268805504,-0.031010178849101067,-0.00031936445157043636,0.0411689355969429,0.06261474639177322,-0.01680787093937397,0.06530273705720901,-0.06544828414916992,0.005182669498026371,0.012642632238566875,-0.05231495574116707,-0.01470994483679533,0.03932312875986099,-0.09626030176877975,0.015207633376121521,-0.001824268838390708,0.042018745094537735,0.027860324829816818,0.077793188393116,-0.009608183987438679,0.07908828556537628,0.005271431524306536,-0.01341939251869917,0.09261257201433182,-0.0017890258459374309,0.0572563074529171,0.007520825136452913,-0.06630335003137589,-0.003442976623773575,-0.011596623808145523,-0.02601642534136772,0.06184365600347519,0.007172558922320604,0.03970618546009064,-0.04194904491305351,0.03909628838300705,-0.03499308228492737,-0.011965099722146988,0.011563139036297798,0.040844254195690155,0.06349844485521317,0.034181587398052216,-0.0013129503931850195,0.1274065226316452,0.0035556356888264418,-0.011571796610951424,-0.00555174145847559,-0.05032264441251755,-0.07162143290042877,-0.0005176470149308443,-0.1187625378370285,0.02141658030450344,-0.023798678070306778,-0.039806194603443146,-0.008016507141292095,0.048939477652311325,0.0505303293466568,0.002852371893823147,0.03783588856458664,0.054348740726709366,-0.09105630218982697,-0.055285219103097916,-0.013313482515513897,0.017733467742800713,0.06518613547086716,-0.027601581066846848,-0.016112396493554115,-0.01777311973273754,-0.043360453099012375,-0.004518741741776466,-0.04228803515434265,-0.05837799236178398,0.02581675536930561,0.06338530033826828,0.01775127276778221,-0.06480953097343445,0.02063095010817051,0.03223579004406929,-0.029196027666330338,0.01511872373521328,-0.08508877456188202,0.014851424843072891,-0.0657309740781784,0.028567476198077202,-0.02246909588575363,-0.016973357647657394,-0.010931972414255142,0.03618905693292618,0.053759049624204636,-0.0200908575206995,-0.05106367915868759,0.04011033847928047,0.0034002382308244705,-0.04074171185493469,0.021766306832432747,0.01480043027549982,-0.07285001128911972,0.00635898020118475,0.010581033304333687,0.0428878553211689,0.015738463029265404,-0.02416406013071537,-0.010637586005032063,-0.02142123505473137,-0.07995079457759857,-0.055265530943870544,0.06283603608608246,-0.015583180822432041,-0.025251325219869614,-0.016005882993340492,0.008251183666288853,-0.015381604433059692,0.04134721681475639,-0.05547904223203659,-0.009593185968697071,-0.030927501618862152,-0.03250158205628395,0.06867486238479614,0.027984334155917168,0.057122375816106796,-0.08126117289066315,-0.057228319346904755,0.08631689846515656,0.04764094203710556,-0.020220475271344185,0.01479322835803032,0.0071993800811469555,0.006258697248995304,0.030760498717427254,0.005762777756899595,-0.03324008733034134,0.05556856095790863,-0.04523453861474991,0.011847241781651974,0.07298821955919266,0.03204358369112015,0.05887962877750397,-0.023152822628617287,-0.04209841042757034,-0.009857894852757454,-0.10206054896116257,0.03672555461525917,0.016743434593081474,-0.08623712509870529,0.06990572065114975,0.06389088183641434,-0.061018235981464386,0.007851328700780869,-0.052093274891376495,-0.011788357980549335,0.04784063994884491,-0.03718795254826546,-0.0801924616098404,0.024000532925128937,0.05194542557001114,0.03213167190551758,-0.0019627143628895283,0.003512538969516754,0.04565064236521721,-0.027982745319604874,0.053844302892684937,-0.008997253142297268,0.02969958446919918,-0.011307016015052795,-0.06577207893133163,0.00622051814571023,-0.018176430836319923,-0.07016400247812271,-0.0315108560025692,0.021819068118929863,-0.006015531253069639,-0.022186197340488434,-0.010428942739963531,-0.07889354974031448,0.01863386109471321,-0.04494890943169594,-0.005853314884006977,0.0008957137470133603,-0.05207908898591995,0.025903599336743355,0.035094328224658966,-0.033177491277456284,0.021745214238762856,-0.007568837609142065,0.035504039376974106,-0.0009169694385491312,-0.029432369396090508,0.016746310517191887,-0.004636785481125116,-0.025615349411964417,0.08080780506134033,-0.09088772535324097,0.02596665360033512,-0.03836304694414139,0.017754314467310905,-0.005217341240495443,0.007763532921671867,0.02663946896791458,-0.029550954699516296,-0.02781056985259056,-0.038072288036346436,0.09748572111129761,-0.012932037934660912,-0.023644553497433662,0.017529349774122238,-0.020663227885961533,0.03659947216510773            ]
query = np.array([query])
import time
start_time = time.time()
ids, distances = index.knnQuery(query, k=10)
print(time.time() - start_time)

print(ids)
print(distances)